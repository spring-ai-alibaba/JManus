import{P as ae,r as f,_ as se,B as b,c as A,Q as re}from"./index-B1KunnxG.js";import{L as k}from"./llm-check-CJy4TeZw.js";const Ie=ae("task",()=>{const t=f(null),e=f(""),o=f(!1);return{currentTask:t,taskToInput:e,hasVisitedHome:o,setTask:c=>{if(console.log("[TaskStore] setTask called with prompt:",c),!c.trim()){console.warn("[TaskStore] Empty prompt provided, not creating task");return}const I={prompt:c,timestamp:Date.now(),processed:!1};t.value=I,console.log("[TaskStore] Task set, currentTask.value:",t.value)},setTaskToInput:c=>{console.log("[TaskStore] setTaskToInput called with prompt:",c),e.value=c,console.log("[TaskStore] Task to input set:",e.value)},getAndClearTaskToInput:()=>{const c=e.value;return e.value="",console.log("[TaskStore] getAndClearTaskToInput returning:",c),c},markTaskAsProcessed:()=>{console.log("[TaskStore] markTaskAsProcessed called, current task:",t.value),t.value?(t.value.processed=!0,console.log("[TaskStore] Task marked as processed:",t.value)):console.log("[TaskStore] No current task to mark as processed")},clearTask:()=>{t.value=null},hasUnprocessedTask:()=>{const c=t.value&&!t.value.processed;return console.log("[TaskStore] hasUnprocessedTask check - currentTask:",t.value,"result:",c),c},markHomeVisited:()=>{o.value=!0,localStorage.setItem("hasVisitedHome","true")},checkHomeVisited:()=>{const c=localStorage.getItem("hasVisitedHome");return o.value=c==="true",o.value},resetHomeVisited:()=>{o.value=!1,localStorage.removeItem("hasVisitedHome")},emitPlanExecutionRequested:c=>{console.log("[TaskStore] emitPlanExecutionRequested called with payload:",c),window.dispatchEvent(new CustomEvent("plan-execution-requested",{detail:c}))},setTaskRunning:c=>{console.log("[TaskStore] setTaskRunning called with planId:",c),t.value?(t.value.planId=c,t.value.isRunning=!0,console.log("[TaskStore] Updated existing task:",t.value)):(t.value={prompt:"",timestamp:Date.now(),processed:!1,planId:c,isRunning:!0},console.log("[TaskStore] Created new task for running state:",t.value))},stopCurrentTask:async()=>{if(console.log("[TaskStore] stopCurrentTask called"),t.value&&t.value.isRunning&&t.value.planId)try{const{DirectApiService:c}=await se(async()=>{const{DirectApiService:I}=await Promise.resolve().then(()=>ie);return{DirectApiService:I}},void 0);return await c.stopTask(t.value.planId),console.log("[TaskStore] Task stopped successfully"),t.value.isRunning=!1,!0}catch(c){return console.error("[TaskStore] Failed to stop task:",c),!1}return!1},hasRunningTask:()=>{const c=t.value&&t.value.isRunning;return console.log("[TaskStore] hasRunningTask check - result:",c),c}}});class ne{isCollapsed=!1;currentTab="list";toggleSidebar(){this.isCollapsed=!this.isCollapsed}switchToTab(e){this.currentTab=e}}const we=b(new ne);class M{static async handleResponse(e){if(!e.ok)try{const o=await e.json(),s=o.error||o.message||`API request failed: ${e.status}`,n=new Error(s);throw o.errorCode&&(n.errorCode=o.errorCode),n}catch(o){throw o instanceof Error?o:new Error(`API request failed: ${e.status} ${e.statusText}`)}return e}static async createOrUpdatePlanTemplateWithTool(e){try{const o=await fetch("/api/plan-template/create-or-update-with-tool",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)});return await(await this.handleResponse(o)).json()}catch(o){throw console.error("Failed to create or update plan template with tool:",o),o}}static async getPlanTemplateConfigVO(e){try{const o=await fetch(`/api/plan-template/${e}/config`);return await(await this.handleResponse(o)).json()}catch(o){throw console.error("Failed to get plan template config VO:",o),o}}static async getAllPlanTemplateConfigVOs(){try{const e=await fetch("/api/plan-template/list-config");return await(await this.handleResponse(e)).json()}catch(e){throw console.error("Failed to get all plan template config VOs:",e),e}}static async deletePlanTemplate(e){try{const o=await fetch("/api/plan-template/delete",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({planId:e})});return await(await this.handleResponse(o)).json()}catch(o){throw console.error("Failed to delete plan template:",o),o}}}class le{isCollapsed=!1;selectMemoryId="";conversationId=null;loadMessages=()=>{};intervalId=void 0;CONVERSATION_ID_KEY="currentConversationId";constructor(){this.loadConversationIdFromStorage()}loadConversationIdFromStorage(){try{const e=localStorage.getItem(this.CONVERSATION_ID_KEY);e&&(this.conversationId=e,console.log("[MemoryStore] Restored conversationId from localStorage:",e))}catch(e){console.warn("[MemoryStore] Failed to load conversationId from localStorage:",e)}}saveConversationIdToStorage(){try{this.conversationId?(localStorage.setItem(this.CONVERSATION_ID_KEY,this.conversationId),console.log("[MemoryStore] Saved conversationId to localStorage:",this.conversationId)):(localStorage.removeItem(this.CONVERSATION_ID_KEY),console.log("[MemoryStore] Removed conversationId from localStorage"))}catch(e){console.warn("[MemoryStore] Failed to save conversationId to localStorage:",e)}}toggleSidebar(){this.isCollapsed=!this.isCollapsed,this.isCollapsed?(this.loadMessages(),this.intervalId=window.setInterval(()=>{this.loadMessages()},3e3)):clearInterval(this.intervalId)}selectMemory(e){this.toggleSidebar(),this.selectMemoryId=e}setMemory(e){this.selectMemoryId=e}defaultMemoryId(){this.selectMemoryId=this.generateRandomId()}clearMemoryId(){this.selectMemoryId=""}setConversationId(e){this.conversationId=e,this.saveConversationIdToStorage()}clearConversationId(){this.conversationId=null,this.saveConversationIdToStorage()}getConversationId(){return this.conversationId}generateRandomId(){return Math.random().toString(36).substring(2,10)}setLoadMessages(e){this.loadMessages=e}}const P=b(new le);class H{static BASE_URL="/api/executor";static async sendMessage(e){return k.withLlmCheck(async()=>{const o={...e,requestSource:"VUE_DIALOG"},s=await fetch(`${this.BASE_URL}/execute`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(o)});if(!s.ok)throw new Error(`API request failed: ${s.status}`);return await s.json()})}static async sendMessageWithDefaultPlan(e,o="VUE_DIALOG"){const s="default-plan-id-001000222",n={userRequirement:e.input};return this.executeByToolName(s,n,e.uploadedFiles,e.uploadKey,o)}static async executeByToolName(e,o,s,n,l="VUE_DIALOG"){return k.withLlmCheck(async()=>{console.log("[DirectApiService] executeByToolName called with:",{toolName:e,replacementParams:o,uploadedFiles:s,uploadKey:n,requestSource:l});const r={toolName:e,requestSource:l};P.conversationId&&(r.conversationId=P.conversationId,console.log("[DirectApiService] Including conversationId from memoryStore:",P.conversationId)),o&&Object.keys(o).length>0&&(r.replacementParams=o,console.log("[DirectApiService] Including replacement params:",o)),s&&s.length>0&&(r.uploadedFiles=s,console.log("[DirectApiService] Including uploaded files:",s.length)),n&&(r.uploadKey=n,console.log("[DirectApiService] Including uploadKey:",n)),console.log("[DirectApiService] Making request to:",`${this.BASE_URL}/executeByToolNameAsync`),console.log("[DirectApiService] Request body:",r);const i=await fetch(`${this.BASE_URL}/executeByToolNameAsync`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(r)});if(console.log("[DirectApiService] Response status:",i.status,i.ok),!i.ok){const T=await i.text();throw console.error("[DirectApiService] Request failed:",T),new Error(`Failed to execute: ${i.status}`)}const d=await i.json();return console.log("[DirectApiService] executeByToolName response:",d),d})}static async stopTask(e){return k.withLlmCheck(async()=>{console.log("[DirectApiService] Stopping task for planId:",e);const o=await fetch(`${this.BASE_URL}/stopTask/${e}`,{method:"POST",headers:{"Content-Type":"application/json"}});if(!o.ok){const s=await o.json().catch(()=>({}));throw new Error(s.error||`Failed to stop task: ${o.status}`)}return await o.json()})}}const ie=Object.freeze(Object.defineProperty({__proto__:null,DirectApiService:H},Symbol.toStringTag,{value:"Module"}));class ce{static PLAN_TEMPLATE_URL="/api/plan-template";static async executePlan(e,o,s,n,l,r="VUE_SIDEBAR"){return k.withLlmCheck(async()=>(console.log("[PlanActApiService] executePlan called with:",{planTemplateId:e,rawParam:o,uploadedFiles:s,replacementParams:n,uploadKey:l,requestSource:r}),o&&(n||(n={}),n.userRequirement=o,console.log("[PlanActApiService] Added rawParam to replacementParams:",o)),await H.executeByToolName(e,n,s,l,r)))}static async getPlanVersions(e){const o=await fetch(`${this.PLAN_TEMPLATE_URL}/versions`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({planId:e})});if(!o.ok)throw new Error(`Failed to get plan versions: ${o.status}`);return await o.json()}static async getAllPlanTemplates(){const e=await fetch(`${this.PLAN_TEMPLATE_URL}/list`);if(!e.ok)throw new Error(`Failed to get plan template list: ${e.status}`);return await e.json()}}function pe(){const t=b({title:"",steps:[],directResponse:!1,planType:"dynamic_agent",planTemplateId:"",readOnly:!1,serviceGroup:""}),e=f(!1),o=f(null),s=f(!1),n=f(!1),l=f([]),r=f(-1),i=f([]),d=f(null),T=f(null),v=()=>t.title,y=()=>t.planType||"dynamic_agent",C=()=>t.serviceGroup||"",E=a=>{t.title=a},G=a=>{t.steps=a||[]},L=a=>{t.planType=a},c=a=>{t.planTemplateId=a},I=a=>{t.serviceGroup=a},N=a=>{a===void 0?delete t.toolConfig:t.toolConfig=a},B=a=>{t.toolConfig||(t.toolConfig={}),t.toolConfig.toolDescription=a},j=a=>{t.toolConfig||(t.toolConfig={}),t.toolConfig.enableInternalToolcall=a},x=a=>{t.toolConfig||(t.toolConfig={}),t.toolConfig.enableHttpService=a},q=a=>{t.toolConfig||(t.toolConfig={}),t.toolConfig.inputSchema=a||[]},w=()=>({...t}),D=a=>{n.value=!0;const p={title:a.title||"",steps:(a.steps||[]).map(g=>({...g,selectedToolKeys:g.selectedToolKeys??[]})),directResponse:a.directResponse||!1,planType:a.planType||"dynamic_agent",planTemplateId:a.planTemplateId||"",readOnly:a.readOnly||!1,serviceGroup:a.serviceGroup||""};a.toolConfig&&(p.toolConfig={...a.toolConfig}),Object.assign(t,p),setTimeout(()=>{n.value=!1},0)},J=()=>{n.value=!0,Object.assign(t,{title:"",steps:[],directResponse:!1,planType:"dynamic_agent",planTemplateId:"",readOnly:!1,serviceGroup:""}),"toolConfig"in t&&delete t.toolConfig,l.value=[],r.value=-1,o.value=null,setTimeout(()=>{n.value=!1},0)},V=()=>{const a={title:t.title||"",steps:(t.steps||[]).map(p=>({...p,selectedToolKeys:p.selectedToolKeys??[]})),directResponse:t.directResponse||!1,planType:t.planType||"dynamic_agent",planTemplateId:t.planTemplateId||"",readOnly:t.readOnly||!1,serviceGroup:t.serviceGroup||""};return t.toolConfig&&(a.toolConfig={...t.toolConfig}),JSON.stringify(a,null,2)},_=a=>{try{const p=JSON.parse(a);return D(p),!0}catch(p){return o.value=p instanceof Error?p.message:"Invalid JSON format",!1}},U=A(()=>l.value.length>1&&r.value>0),F=A(()=>l.value.length>1&&r.value<l.value.length-1),K=()=>{if(U.value&&r.value>0){r.value--;const a=l.value[r.value]||"";_(a)}},Y=()=>{if(F.value&&r.value<l.value.length-1){r.value++;const a=l.value[r.value]||"";_(a)}},Q=a=>{r.value<l.value.length-1&&(l.value=l.value.slice(0,r.value+1)),l.value.push(a),r.value=l.value.length-1},$=async a=>{if(!a)return o.value="Plan template ID is required",!1;try{e.value=!0,o.value=null;const p=await M.getPlanTemplateConfigVO(a);D(p);try{const g=await ce.getPlanVersions(a);l.value=g.versions||[],l.value.length>0?r.value=l.value.length-1:r.value=-1}catch(g){console.warn("Failed to load plan versions:",g),l.value=[],r.value=-1}return!0}catch(p){return o.value=p instanceof Error?p.message:"Failed to load plan template config",console.error("Failed to load plan template config:",p),!1}finally{e.value=!1}},X=async()=>{if(!t.planTemplateId)return o.value="Plan template ID is required",!1;try{e.value=!0,o.value=null;const a=await M.createOrUpdatePlanTemplateWithTool(w());if(a.success){const p=t.planTemplateId;if(p){if(await $(p),d.value?.planTemplateId===p){const h=w();d.value={...d.value,...h}}const g=i.value.findIndex(h=>h.planTemplateId===p);if(g>=0){const h=w();i.value[g]={...i.value[g],...h}}}}return a.success}catch(a){return o.value=a instanceof Error?a.message:"Failed to save plan template config",console.error("Failed to save plan template config:",a),!1}finally{e.value=!1}},Z=()=>{const a=[];return t.planTemplateId?.trim()||a.push("Plan template ID is required"),t.title?.trim()||a.push("Title is required"),(!t.steps||t.steps.length===0)&&a.push("At least one step is required"),{isValid:a.length===0,errors:a}},ee=a=>a?Array.isArray(a)&&a.length>=6?new Date(a[0],a[1]-1,a[2],a[3],a[4],a[5],Math.floor(a[6]/1e6)):typeof a=="string"?new Date(a):new Date:new Date,te=()=>{const a=[];for(const p of i.value){if(!p.toolConfig)continue;const g=p.toolConfig;if(!g.enableInternalToolcall)continue;let h="[]";g.inputSchema&&Array.isArray(g.inputSchema)&&(h=JSON.stringify(g.inputSchema));const z={toolName:p.title||"",toolDescription:g.toolDescription||"",planTemplateId:p.planTemplateId||"",inputSchema:h,enableInternalToolcall:g.enableInternalToolcall??!0,enableHttpService:g.enableHttpService??!1,enableMcpService:g.enableMcpService??!1};p.serviceGroup&&(z.serviceGroup=p.serviceGroup),a.push(z)}return a},oe=()=>i.value.some(a=>a.toolConfig!==void 0),S=a=>{s.value=!0;try{return a()}finally{setTimeout(()=>{s.value=!1},0)}};return{config:t,isLoading:e,error:o,isUserUpdating:s,needsFullRefresh:n,planVersions:l,currentVersionIndex:r,planTemplateList:i,selectedTemplate:d,currentPlanTemplateId:T,getTitle:v,getPlanType:y,getServiceGroup:C,getConfig:w,setTitle:E,setSteps:G,setPlanType:L,setPlanTemplateId:c,setServiceGroup:I,setToolConfig:N,setToolDescription:B,setEnableInternalToolcall:j,setEnableHttpService:x,setInputSchema:q,setConfig:D,setStepsWithGuard:a=>S(()=>{G(a)}),setToolConfigWithGuard:a=>S(()=>{N(a)}),setToolDescriptionWithGuard:a=>S(()=>{B(a)}),setEnableInternalToolcallWithGuard:a=>S(()=>{j(a)}),setEnableHttpServiceWithGuard:a=>S(()=>{x(a)}),setInputSchemaWithGuard:a=>S(()=>{q(a)}),withUpdateGuard:S,reset:J,load:$,save:X,validate:Z,generateJsonString:V,fromJsonString:_,rollbackVersion:K,restoreVersion:Y,updateVersionsAfterSave:Q,canRollback:U,canRestore:F,parseDateTime:ee,getAllCoordinatorToolsFromTemplates:te,getCoordinatorToolConfig:oe}}let R=null;function W(){return R||(R=pe()),R}class ue{isLoading=!1;errorMessage="";hasTaskRequirementModified=!1;organizationMethod="by_time";templateServiceGroups=new Map;groupCollapseState={};constructor(){const e=localStorage.getItem("sidebarOrganizationMethod");e&&["by_time","by_abc","by_group_time","by_group_abc"].includes(e)&&(this.organizationMethod=e),this.loadGroupCollapseState()}loadGroupCollapseState(){try{const e=localStorage.getItem("sidebarGroupCollapseState");if(e){const o=JSON.parse(e);this.groupCollapseState=o||{}}}catch(e){console.warn("[TemplateStore] Failed to load group collapse state:",e)}}saveGroupCollapseState(){try{localStorage.setItem("sidebarGroupCollapseState",JSON.stringify(this.groupCollapseState))}catch(e){console.warn("[TemplateStore] Failed to save group collapse state:",e)}}toggleGroupCollapse(e){const o=e??"null",s=this.groupCollapseState[o]??!1;this.groupCollapseState[o]=!s,this.saveGroupCollapseState()}isGroupCollapsed(e){const o=e??"null";return this.groupCollapseState[o]??!1}parseDateTime(e){return e?Array.isArray(e)&&e.length>=6?new Date(e[0],e[1]-1,e[2],e[3],e[4],e[5],Math.floor(e[6]/1e6)):typeof e=="string"?new Date(e):new Date:new Date}templateConfig=W();setOrganizationMethod(e){this.organizationMethod=e,localStorage.setItem("sidebarOrganizationMethod",e)}async loadPlanTemplateList(){this.isLoading=!0,this.errorMessage="";try{console.log("[TemplateStore] Starting to load plan template list...");const e=await M.getAllPlanTemplateConfigVOs();this.templateConfig.planTemplateList.value=e,this.templateServiceGroups.clear();for(const o of this.templateConfig.planTemplateList.value){const s=o.planTemplateId;if(s){const n=o.serviceGroup||"";n&&this.templateServiceGroups.set(s,n)}}console.log(`[TemplateStore] Successfully loaded ${this.templateConfig.planTemplateList.value.length} plan templates`)}catch(e){console.error("[TemplateStore] Failed to load plan template list:",e),this.templateConfig.planTemplateList.value=[];const o=e instanceof Error?e.message:"Unknown error";this.errorMessage=`Load failed: ${o}`}finally{this.isLoading=!1}}async selectTemplate(e){this.templateConfig.currentPlanTemplateId.value=e.planTemplateId||null,this.templateConfig.selectedTemplate.value=e,this.hasTaskRequirementModified=!1,console.log(`[TemplateStore] Selected plan template: ${e.planTemplateId}`)}async createNewTemplate(e){const o={planTemplateId:`new-${Date.now()}`,title:re.global.t("sidebar.newTemplateName"),planType:e,createTime:new Date().toISOString(),updateTime:new Date().toISOString()};this.templateConfig.selectedTemplate.value=o,this.templateConfig.currentPlanTemplateId.value=null,this.hasTaskRequirementModified=!1,console.log("[TemplateStore] Created new empty plan template")}async deleteTemplate(e){const o=e.planTemplateId;if(!o){console.warn("[TemplateStore] deleteTemplate: Invalid template object or ID");return}try{await M.deletePlanTemplate(o),this.templateConfig.currentPlanTemplateId.value===o&&this.clearSelection(),await this.loadPlanTemplateList(),console.log(`[TemplateStore] Plan template ${o} has been deleted`)}catch(s){throw console.error("Failed to delete plan template:",s),await this.loadPlanTemplateList(),s}}clearSelection(){this.templateConfig.currentPlanTemplateId.value=null,this.templateConfig.selectedTemplate.value=null,this.hasTaskRequirementModified=!1}}const m=new ue,de=W(),u=b({isLoading:m.isLoading,errorMessage:m.errorMessage,hasTaskRequirementModified:m.hasTaskRequirementModified,organizationMethod:m.organizationMethod,templateServiceGroups:m.templateServiceGroups,groupCollapseState:m.groupCollapseState,loadGroupCollapseState:()=>m.loadGroupCollapseState(),saveGroupCollapseState:()=>m.saveGroupCollapseState(),toggleGroupCollapse:t=>{m.toggleGroupCollapse(t);const e=t??"null";u.groupCollapseState[e]=m.groupCollapseState[e],u.groupCollapseState={...u.groupCollapseState}},isGroupCollapsed:t=>m.isGroupCollapsed(t),parseDateTime:t=>m.parseDateTime(t),setOrganizationMethod:t=>{m.setOrganizationMethod(t),u.organizationMethod=t},loadPlanTemplateList:async()=>{await m.loadPlanTemplateList(),u.isLoading=m.isLoading,u.errorMessage=m.errorMessage,u.templateServiceGroups=m.templateServiceGroups},selectTemplate:t=>m.selectTemplate(t),createNewTemplate:t=>m.createNewTemplate(t),deleteTemplate:t=>m.deleteTemplate(t),clearSelection:()=>m.clearSelection()}),O=A(()=>{const t=[...de.planTemplateList.value];switch(u.organizationMethod){case"by_time":return t.sort((e,o)=>{const s=u.parseDateTime(e.updateTime??e.createTime);return u.parseDateTime(o.updateTime??o.createTime).getTime()-s.getTime()});case"by_abc":return t.sort((e,o)=>{const s=(e.title??"").toLowerCase(),n=(o.title??"").toLowerCase();return s.localeCompare(n)});case"by_group_time":case"by_group_abc":{const e=new Map,o=[];t.forEach(r=>{const i=r.planTemplateId||"",d=u.templateServiceGroups.get(i)??"";!d||d==="default"||d===""?o.push(r):(e.has(d)||e.set(d,[]),e.get(d).push(r))});const s=new Map;e.forEach((r,i)=>{const d=[...r];u.organizationMethod==="by_group_time"?d.sort((T,v)=>{const y=u.parseDateTime(T.updateTime??T.createTime);return u.parseDateTime(v.updateTime??v.createTime).getTime()-y.getTime()}):d.sort((T,v)=>{const y=(T.title??"").toLowerCase(),C=(v.title??"").toLowerCase();return y.localeCompare(C)}),s.set(i,d)}),u.organizationMethod==="by_group_time"?o.sort((r,i)=>{const d=u.parseDateTime(r.updateTime??r.createTime);return u.parseDateTime(i.updateTime??i.createTime).getTime()-d.getTime()}):o.sort((r,i)=>{const d=(r.title??"").toLowerCase(),T=(i.title??"").toLowerCase();return d.localeCompare(T)});const n=[];return n.push(...o),Array.from(s.keys()).sort().forEach(r=>{n.push(...s.get(r))}),n}default:return t.sort((e,o)=>{const s=u.parseDateTime(e.updateTime||e.createTime||"");return u.parseDateTime(o.updateTime||o.createTime||"").getTime()-s.getTime()})}}),me=A(()=>{if(u.organizationMethod!=="by_group_time"&&u.organizationMethod!=="by_group_abc")return new Map([[null,O.value]]);const t=new Map,e=[];O.value.forEach(l=>{const r=l.planTemplateId||"",i=u.templateServiceGroups.get(r)??"";!i||i==="default"||i===""?e.push(l):(t.has(i)||t.set(i,[]),t.get(i).push(l))});const s=new Map;return e.length>0&&s.set(null,e),Array.from(t.keys()).sort().forEach(l=>{s.set(l,t.get(l))}),s});Object.defineProperty(u,"sortedTemplates",{get:()=>O.value,enumerable:!0,configurable:!0});Object.defineProperty(u,"groupedTemplates",{get:()=>me.value,enumerable:!0,configurable:!0});export{H as D,ce as P,W as a,M as b,P as m,we as s,u as t,Ie as u};
//# sourceMappingURL=templateStore-BAIqgfnz.js.map
