import{P as oe,r as h,_ as ae,B as b,c as A,Q as se}from"./index-BFA_qvXM.js";import{L as k}from"./llm-check-CJy4TeZw.js";const Ce=oe("task",()=>{const t=h(null),e=h(""),o=h(!1);return{currentTask:t,taskToInput:e,hasVisitedHome:o,setTask:i=>{if(console.log("[TaskStore] setTask called with prompt:",i),!i.trim()){console.warn("[TaskStore] Empty prompt provided, not creating task");return}const C={prompt:i,timestamp:Date.now(),processed:!1};t.value=C,console.log("[TaskStore] Task set, currentTask.value:",t.value)},setTaskToInput:i=>{console.log("[TaskStore] setTaskToInput called with prompt:",i),e.value=i,console.log("[TaskStore] Task to input set:",e.value)},getAndClearTaskToInput:()=>{const i=e.value;return e.value="",console.log("[TaskStore] getAndClearTaskToInput returning:",i),i},markTaskAsProcessed:()=>{console.log("[TaskStore] markTaskAsProcessed called, current task:",t.value),t.value?(t.value.processed=!0,console.log("[TaskStore] Task marked as processed:",t.value)):console.log("[TaskStore] No current task to mark as processed")},clearTask:()=>{t.value=null},hasUnprocessedTask:()=>{const i=t.value&&!t.value.processed;return console.log("[TaskStore] hasUnprocessedTask check - currentTask:",t.value,"result:",i),i},markHomeVisited:()=>{o.value=!0,localStorage.setItem("hasVisitedHome","true")},checkHomeVisited:()=>{const i=localStorage.getItem("hasVisitedHome");return o.value=i==="true",o.value},resetHomeVisited:()=>{o.value=!1,localStorage.removeItem("hasVisitedHome")},emitPlanExecutionRequested:i=>{console.log("[TaskStore] emitPlanExecutionRequested called with payload:",i),window.dispatchEvent(new CustomEvent("plan-execution-requested",{detail:i}))},setTaskRunning:i=>{console.log("[TaskStore] setTaskRunning called with planId:",i),t.value?(t.value.planId=i,t.value.isRunning=!0,console.log("[TaskStore] Updated existing task:",t.value)):(t.value={prompt:"",timestamp:Date.now(),processed:!1,planId:i,isRunning:!0},console.log("[TaskStore] Created new task for running state:",t.value))},stopCurrentTask:async()=>{if(console.log("[TaskStore] stopCurrentTask called"),t.value&&t.value.isRunning&&t.value.planId)try{const{DirectApiService:i}=await ae(async()=>{const{DirectApiService:C}=await Promise.resolve().then(()=>le);return{DirectApiService:C}},void 0);return await i.stopTask(t.value.planId),console.log("[TaskStore] Task stopped successfully"),t.value.isRunning=!1,!0}catch(i){return console.error("[TaskStore] Failed to stop task:",i),!1}return!1},hasRunningTask:()=>{const i=t.value&&t.value.isRunning;return console.log("[TaskStore] hasRunningTask check - result:",i),i}}});class re{isCollapsed=!1;currentTab="list";toggleSidebar(){this.isCollapsed=!this.isCollapsed}switchToTab(e){this.currentTab=e}}const Ie=b(new re);class M{static async handleResponse(e){if(!e.ok)try{const o=await e.json(),s=o.error||o.message||`API request failed: ${e.status}`,r=new Error(s);throw o.errorCode&&(r.errorCode=o.errorCode),r}catch(o){throw o instanceof Error?o:new Error(`API request failed: ${e.status} ${e.statusText}`)}return e}static async createOrUpdatePlanTemplateWithTool(e){try{const o=await fetch("/api/plan-template/create-or-update-with-tool",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)});return await(await this.handleResponse(o)).json()}catch(o){throw console.error("Failed to create or update plan template with tool:",o),o}}static async getPlanTemplateConfigVO(e){try{const o=await fetch(`/api/plan-template/${e}/config`);return await(await this.handleResponse(o)).json()}catch(o){throw console.error("Failed to get plan template config VO:",o),o}}static async getAllPlanTemplateConfigVOs(){try{const e=await fetch("/api/plan-template/list-config");return await(await this.handleResponse(e)).json()}catch(e){throw console.error("Failed to get all plan template config VOs:",e),e}}static async deletePlanTemplate(e){try{const o=await fetch("/api/plan-template/delete",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({planId:e})});return await(await this.handleResponse(o)).json()}catch(o){throw console.error("Failed to delete plan template:",o),o}}}class ne{isCollapsed=!1;selectMemoryId="";conversationId=null;loadMessages=()=>{};intervalId=void 0;CONVERSATION_ID_KEY="currentConversationId";constructor(){this.loadConversationIdFromStorage()}loadConversationIdFromStorage(){try{const e=localStorage.getItem(this.CONVERSATION_ID_KEY);e&&(this.conversationId=e,console.log("[MemoryStore] Restored conversationId from localStorage:",e))}catch(e){console.warn("[MemoryStore] Failed to load conversationId from localStorage:",e)}}saveConversationIdToStorage(){try{this.conversationId?(localStorage.setItem(this.CONVERSATION_ID_KEY,this.conversationId),console.log("[MemoryStore] Saved conversationId to localStorage:",this.conversationId)):(localStorage.removeItem(this.CONVERSATION_ID_KEY),console.log("[MemoryStore] Removed conversationId from localStorage"))}catch(e){console.warn("[MemoryStore] Failed to save conversationId to localStorage:",e)}}toggleSidebar(){this.isCollapsed=!this.isCollapsed,this.isCollapsed?(this.loadMessages(),this.intervalId=window.setInterval(()=>{this.loadMessages()},3e3)):clearInterval(this.intervalId)}selectMemory(e){this.toggleSidebar(),this.selectMemoryId=e}setMemory(e){this.selectMemoryId=e}defaultMemoryId(){this.selectMemoryId=this.generateRandomId()}clearMemoryId(){this.selectMemoryId=""}setConversationId(e){this.conversationId=e,this.saveConversationIdToStorage()}clearConversationId(){this.conversationId=null,this.saveConversationIdToStorage()}getConversationId(){return this.conversationId}generateRandomId(){return Math.random().toString(36).substring(2,10)}setLoadMessages(e){this.loadMessages=e}}const P=b(new ne);class z{static BASE_URL="/api/executor";static async sendMessage(e){return k.withLlmCheck(async()=>{const o={...e,requestSource:"VUE_DIALOG"},s=await fetch(`${this.BASE_URL}/execute`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(o)});if(!s.ok)throw new Error(`API request failed: ${s.status}`);return await s.json()})}static async sendMessageWithDefaultPlan(e,o="VUE_DIALOG"){const s="default-plan-id-001000222",r={userRequirement:e.input};return this.executeByToolName(s,r,e.uploadedFiles,e.uploadKey,o)}static async executeByToolName(e,o,s,r,l="VUE_DIALOG"){return k.withLlmCheck(async()=>{console.log("[DirectApiService] executeByToolName called with:",{toolName:e,replacementParams:o,uploadedFiles:s,uploadKey:r,requestSource:l});const n={toolName:e,requestSource:l};P.conversationId&&(n.conversationId=P.conversationId,console.log("[DirectApiService] Including conversationId from memoryStore:",P.conversationId)),o&&Object.keys(o).length>0&&(n.replacementParams=o,console.log("[DirectApiService] Including replacement params:",o)),s&&s.length>0&&(n.uploadedFiles=s,console.log("[DirectApiService] Including uploaded files:",s.length)),r&&(n.uploadKey=r,console.log("[DirectApiService] Including uploadKey:",r)),console.log("[DirectApiService] Making request to:",`${this.BASE_URL}/executeByToolNameAsync`),console.log("[DirectApiService] Request body:",n);const c=await fetch(`${this.BASE_URL}/executeByToolNameAsync`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(n)});if(console.log("[DirectApiService] Response status:",c.status,c.ok),!c.ok){const T=await c.text();throw console.error("[DirectApiService] Request failed:",T),new Error(`Failed to execute: ${c.status}`)}const m=await c.json();return console.log("[DirectApiService] executeByToolName response:",m),m})}static async stopTask(e){return k.withLlmCheck(async()=>{console.log("[DirectApiService] Stopping task for planId:",e);const o=await fetch(`${this.BASE_URL}/stopTask/${e}`,{method:"POST",headers:{"Content-Type":"application/json"}});if(!o.ok){const s=await o.json().catch(()=>({}));throw new Error(s.error||`Failed to stop task: ${o.status}`)}return await o.json()})}}const le=Object.freeze(Object.defineProperty({__proto__:null,DirectApiService:z},Symbol.toStringTag,{value:"Module"}));class ie{static PLAN_TEMPLATE_URL="/api/plan-template";static async executePlan(e,o,s,r,l,n="VUE_SIDEBAR"){return k.withLlmCheck(async()=>(console.log("[PlanActApiService] executePlan called with:",{planTemplateId:e,rawParam:o,uploadedFiles:s,replacementParams:r,uploadKey:l,requestSource:n}),o&&(r||(r={}),r.userRequirement=o,console.log("[PlanActApiService] Added rawParam to replacementParams:",o)),await z.executeByToolName(e,r,s,l,n)))}static async getPlanVersions(e){const o=await fetch(`${this.PLAN_TEMPLATE_URL}/versions`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({planId:e})});if(!o.ok)throw new Error(`Failed to get plan versions: ${o.status}`);return await o.json()}static async getAllPlanTemplates(){const e=await fetch(`${this.PLAN_TEMPLATE_URL}/list`);if(!e.ok)throw new Error(`Failed to get plan template list: ${e.status}`);return await e.json()}}function ce(){const t=b({title:"",steps:[],directResponse:!1,planType:"dynamic_agent",planTemplateId:"",readOnly:!1,serviceGroup:""}),e=h(!1),o=h(null),s=h(!1),r=h([]),l=h(-1),n=h([]),c=h(null),m=h(null),T=()=>t.title,v=()=>t.planType||"dynamic_agent",y=()=>t.serviceGroup||"",I=a=>{t.title=a},G=a=>{t.steps=a||[]},E=a=>{t.planType=a},L=a=>{t.planTemplateId=a},i=a=>{t.serviceGroup=a},C=a=>{a===void 0?delete t.toolConfig:t.toolConfig=a},N=a=>{t.toolConfig||(t.toolConfig={}),t.toolConfig.toolDescription=a},B=a=>{t.toolConfig||(t.toolConfig={}),t.toolConfig.enableInternalToolcall=a},j=a=>{t.toolConfig||(t.toolConfig={}),t.toolConfig.enableHttpService=a},x=a=>{t.toolConfig||(t.toolConfig={}),t.toolConfig.inputSchema=a||[]},w=()=>({...t}),D=a=>{const p={title:a.title||"",steps:(a.steps||[]).map(g=>({...g,selectedToolKeys:g.selectedToolKeys??[]})),directResponse:a.directResponse||!1,planType:a.planType||"dynamic_agent",planTemplateId:a.planTemplateId||"",readOnly:a.readOnly||!1,serviceGroup:a.serviceGroup||""};a.toolConfig&&(p.toolConfig={...a.toolConfig}),Object.assign(t,p)},W=()=>{Object.assign(t,{title:"",steps:[],directResponse:!1,planType:"dynamic_agent",planTemplateId:"",readOnly:!1,serviceGroup:""}),"toolConfig"in t&&delete t.toolConfig,r.value=[],l.value=-1,o.value=null},J=()=>{const a={title:t.title||"",steps:(t.steps||[]).map(p=>({...p,selectedToolKeys:p.selectedToolKeys??[]})),directResponse:t.directResponse||!1,planType:t.planType||"dynamic_agent",planTemplateId:t.planTemplateId||"",readOnly:t.readOnly||!1,serviceGroup:t.serviceGroup||""};return t.toolConfig&&(a.toolConfig={...t.toolConfig}),JSON.stringify(a,null,2)},_=a=>{try{const p=JSON.parse(a);return D(p),!0}catch(p){return o.value=p instanceof Error?p.message:"Invalid JSON format",!1}},q=A(()=>r.value.length>1&&l.value>0),U=A(()=>r.value.length>1&&l.value<r.value.length-1),V=()=>{if(q.value&&l.value>0){l.value--;const a=r.value[l.value]||"";_(a)}},K=()=>{if(U.value&&l.value<r.value.length-1){l.value++;const a=r.value[l.value]||"";_(a)}},Y=a=>{l.value<r.value.length-1&&(r.value=r.value.slice(0,l.value+1)),r.value.push(a),l.value=r.value.length-1},$=async a=>{if(!a)return o.value="Plan template ID is required",!1;try{e.value=!0,o.value=null;const p=await M.getPlanTemplateConfigVO(a);D(p);try{const g=await ie.getPlanVersions(a);r.value=g.versions||[],r.value.length>0?l.value=r.value.length-1:l.value=-1}catch(g){console.warn("Failed to load plan versions:",g),r.value=[],l.value=-1}return!0}catch(p){return o.value=p instanceof Error?p.message:"Failed to load plan template config",console.error("Failed to load plan template config:",p),!1}finally{e.value=!1}},Q=async()=>{if(!t.planTemplateId)return o.value="Plan template ID is required",!1;try{e.value=!0,o.value=null;const a=await M.createOrUpdatePlanTemplateWithTool(w());if(a.success){const p=t.planTemplateId;if(p){if(await $(p),c.value?.planTemplateId===p){const f=w();c.value={...c.value,...f}}const g=n.value.findIndex(f=>f.planTemplateId===p);if(g>=0){const f=w();n.value[g]={...n.value[g],...f}}}}return a.success}catch(a){return o.value=a instanceof Error?a.message:"Failed to save plan template config",console.error("Failed to save plan template config:",a),!1}finally{e.value=!1}},X=()=>{const a=[];return t.planTemplateId?.trim()||a.push("Plan template ID is required"),t.title?.trim()||a.push("Title is required"),(!t.steps||t.steps.length===0)&&a.push("At least one step is required"),{isValid:a.length===0,errors:a}},Z=a=>a?Array.isArray(a)&&a.length>=6?new Date(a[0],a[1]-1,a[2],a[3],a[4],a[5],Math.floor(a[6]/1e6)):typeof a=="string"?new Date(a):new Date:new Date,ee=()=>{const a=[];for(const p of n.value){if(!p.toolConfig)continue;const g=p.toolConfig;if(!g.enableInternalToolcall)continue;let f="[]";g.inputSchema&&Array.isArray(g.inputSchema)&&(f=JSON.stringify(g.inputSchema));const F={toolName:p.title||"",toolDescription:g.toolDescription||"",planTemplateId:p.planTemplateId||"",inputSchema:f,enableInternalToolcall:g.enableInternalToolcall??!0,enableHttpService:g.enableHttpService??!1,enableMcpService:g.enableMcpService??!1};p.serviceGroup&&(F.serviceGroup=p.serviceGroup),a.push(F)}return a},te=()=>n.value.some(a=>a.toolConfig!==void 0),S=a=>{s.value=!0;try{return a()}finally{setTimeout(()=>{s.value=!1},0)}};return{config:t,isLoading:e,error:o,isUserUpdating:s,planVersions:r,currentVersionIndex:l,planTemplateList:n,selectedTemplate:c,currentPlanTemplateId:m,getTitle:T,getPlanType:v,getServiceGroup:y,getConfig:w,setTitle:I,setSteps:G,setPlanType:E,setPlanTemplateId:L,setServiceGroup:i,setToolConfig:C,setToolDescription:N,setEnableInternalToolcall:B,setEnableHttpService:j,setInputSchema:x,setConfig:D,setStepsWithGuard:a=>S(()=>{G(a)}),setToolConfigWithGuard:a=>S(()=>{C(a)}),setToolDescriptionWithGuard:a=>S(()=>{N(a)}),setEnableInternalToolcallWithGuard:a=>S(()=>{B(a)}),setEnableHttpServiceWithGuard:a=>S(()=>{j(a)}),setInputSchemaWithGuard:a=>S(()=>{x(a)}),withUpdateGuard:S,reset:W,load:$,save:Q,validate:X,generateJsonString:J,fromJsonString:_,rollbackVersion:V,restoreVersion:K,updateVersionsAfterSave:Y,canRollback:q,canRestore:U,parseDateTime:Z,getAllCoordinatorToolsFromTemplates:ee,getCoordinatorToolConfig:te}}let O=null;function H(){return O||(O=ce()),O}class pe{isLoading=!1;errorMessage="";hasTaskRequirementModified=!1;organizationMethod="by_time";templateServiceGroups=new Map;groupCollapseState={};constructor(){const e=localStorage.getItem("sidebarOrganizationMethod");e&&["by_time","by_abc","by_group_time","by_group_abc"].includes(e)&&(this.organizationMethod=e),this.loadGroupCollapseState()}loadGroupCollapseState(){try{const e=localStorage.getItem("sidebarGroupCollapseState");if(e){const o=JSON.parse(e);this.groupCollapseState=o||{}}}catch(e){console.warn("[TemplateStore] Failed to load group collapse state:",e)}}saveGroupCollapseState(){try{localStorage.setItem("sidebarGroupCollapseState",JSON.stringify(this.groupCollapseState))}catch(e){console.warn("[TemplateStore] Failed to save group collapse state:",e)}}toggleGroupCollapse(e){const o=e??"null",s=this.groupCollapseState[o]??!1;this.groupCollapseState[o]=!s,this.saveGroupCollapseState()}isGroupCollapsed(e){const o=e??"null";return this.groupCollapseState[o]??!1}parseDateTime(e){return e?Array.isArray(e)&&e.length>=6?new Date(e[0],e[1]-1,e[2],e[3],e[4],e[5],Math.floor(e[6]/1e6)):typeof e=="string"?new Date(e):new Date:new Date}templateConfig=H();setOrganizationMethod(e){this.organizationMethod=e,localStorage.setItem("sidebarOrganizationMethod",e)}async loadPlanTemplateList(){this.isLoading=!0,this.errorMessage="";try{console.log("[TemplateStore] Starting to load plan template list...");const e=await M.getAllPlanTemplateConfigVOs();this.templateConfig.planTemplateList.value=e,this.templateServiceGroups.clear();for(const o of this.templateConfig.planTemplateList.value){const s=o.planTemplateId;if(s){const r=o.serviceGroup||"";r&&this.templateServiceGroups.set(s,r)}}console.log(`[TemplateStore] Successfully loaded ${this.templateConfig.planTemplateList.value.length} plan templates`)}catch(e){console.error("[TemplateStore] Failed to load plan template list:",e),this.templateConfig.planTemplateList.value=[];const o=e instanceof Error?e.message:"Unknown error";this.errorMessage=`Load failed: ${o}`}finally{this.isLoading=!1}}async selectTemplate(e){this.templateConfig.currentPlanTemplateId.value=e.planTemplateId||null,this.templateConfig.selectedTemplate.value=e,this.hasTaskRequirementModified=!1,console.log(`[TemplateStore] Selected plan template: ${e.planTemplateId}`)}async createNewTemplate(e){const o={planTemplateId:`new-${Date.now()}`,title:se.global.t("sidebar.newTemplateName"),planType:e,createTime:new Date().toISOString(),updateTime:new Date().toISOString()};this.templateConfig.selectedTemplate.value=o,this.templateConfig.currentPlanTemplateId.value=null,this.hasTaskRequirementModified=!1,console.log("[TemplateStore] Created new empty plan template")}async deleteTemplate(e){const o=e.planTemplateId;if(!o){console.warn("[TemplateStore] deleteTemplate: Invalid template object or ID");return}try{await M.deletePlanTemplate(o),this.templateConfig.currentPlanTemplateId.value===o&&this.clearSelection(),await this.loadPlanTemplateList(),console.log(`[TemplateStore] Plan template ${o} has been deleted`)}catch(s){throw console.error("Failed to delete plan template:",s),await this.loadPlanTemplateList(),s}}clearSelection(){this.templateConfig.currentPlanTemplateId.value=null,this.templateConfig.selectedTemplate.value=null,this.hasTaskRequirementModified=!1}}const d=new pe,ue=H(),u=b({isLoading:d.isLoading,errorMessage:d.errorMessage,hasTaskRequirementModified:d.hasTaskRequirementModified,organizationMethod:d.organizationMethod,templateServiceGroups:d.templateServiceGroups,groupCollapseState:d.groupCollapseState,loadGroupCollapseState:()=>d.loadGroupCollapseState(),saveGroupCollapseState:()=>d.saveGroupCollapseState(),toggleGroupCollapse:t=>{d.toggleGroupCollapse(t);const e=t??"null";u.groupCollapseState[e]=d.groupCollapseState[e],u.groupCollapseState={...u.groupCollapseState}},isGroupCollapsed:t=>d.isGroupCollapsed(t),parseDateTime:t=>d.parseDateTime(t),setOrganizationMethod:t=>{d.setOrganizationMethod(t),u.organizationMethod=t},loadPlanTemplateList:async()=>{await d.loadPlanTemplateList(),u.isLoading=d.isLoading,u.errorMessage=d.errorMessage,u.templateServiceGroups=d.templateServiceGroups},selectTemplate:t=>d.selectTemplate(t),createNewTemplate:t=>d.createNewTemplate(t),deleteTemplate:t=>d.deleteTemplate(t),clearSelection:()=>d.clearSelection()}),R=A(()=>{const t=[...ue.planTemplateList.value];switch(u.organizationMethod){case"by_time":return t.sort((e,o)=>{const s=u.parseDateTime(e.updateTime??e.createTime);return u.parseDateTime(o.updateTime??o.createTime).getTime()-s.getTime()});case"by_abc":return t.sort((e,o)=>{const s=(e.title??"").toLowerCase(),r=(o.title??"").toLowerCase();return s.localeCompare(r)});case"by_group_time":case"by_group_abc":{const e=new Map,o=[];t.forEach(n=>{const c=n.planTemplateId||"",m=u.templateServiceGroups.get(c)??"";!m||m==="default"||m===""?o.push(n):(e.has(m)||e.set(m,[]),e.get(m).push(n))});const s=new Map;e.forEach((n,c)=>{const m=[...n];u.organizationMethod==="by_group_time"?m.sort((T,v)=>{const y=u.parseDateTime(T.updateTime??T.createTime);return u.parseDateTime(v.updateTime??v.createTime).getTime()-y.getTime()}):m.sort((T,v)=>{const y=(T.title??"").toLowerCase(),I=(v.title??"").toLowerCase();return y.localeCompare(I)}),s.set(c,m)}),u.organizationMethod==="by_group_time"?o.sort((n,c)=>{const m=u.parseDateTime(n.updateTime??n.createTime);return u.parseDateTime(c.updateTime??c.createTime).getTime()-m.getTime()}):o.sort((n,c)=>{const m=(n.title??"").toLowerCase(),T=(c.title??"").toLowerCase();return m.localeCompare(T)});const r=[];return r.push(...o),Array.from(s.keys()).sort().forEach(n=>{r.push(...s.get(n))}),r}default:return t.sort((e,o)=>{const s=u.parseDateTime(e.updateTime||e.createTime||"");return u.parseDateTime(o.updateTime||o.createTime||"").getTime()-s.getTime()})}}),de=A(()=>{if(u.organizationMethod!=="by_group_time"&&u.organizationMethod!=="by_group_abc")return new Map([[null,R.value]]);const t=new Map,e=[];R.value.forEach(l=>{const n=l.planTemplateId||"",c=u.templateServiceGroups.get(n)??"";!c||c==="default"||c===""?e.push(l):(t.has(c)||t.set(c,[]),t.get(c).push(l))});const s=new Map;return e.length>0&&s.set(null,e),Array.from(t.keys()).sort().forEach(l=>{s.set(l,t.get(l))}),s});Object.defineProperty(u,"sortedTemplates",{get:()=>R.value,enumerable:!0,configurable:!0});Object.defineProperty(u,"groupedTemplates",{get:()=>de.value,enumerable:!0,configurable:!0});export{z as D,ie as P,H as a,M as b,P as m,Ie as s,u as t,Ce as u};
//# sourceMappingURL=templateStore-DVP7gbuB.js.map
