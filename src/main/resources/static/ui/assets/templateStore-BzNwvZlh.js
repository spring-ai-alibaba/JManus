import{P as Y,r as f,_ as W,B as M,c as k,Q}from"./index-flMhGIYM.js";import{L as w}from"./llm-check-CJy4TeZw.js";const me=Y("task",()=>{const t=f(null),e=f(""),o=f(!1);return{currentTask:t,taskToInput:e,hasVisitedHome:o,setTask:l=>{if(console.log("[TaskStore] setTask called with prompt:",l),!l.trim()){console.warn("[TaskStore] Empty prompt provided, not creating task");return}const C={prompt:l,timestamp:Date.now(),processed:!1};t.value=C,console.log("[TaskStore] Task set, currentTask.value:",t.value)},setTaskToInput:l=>{console.log("[TaskStore] setTaskToInput called with prompt:",l),e.value=l,console.log("[TaskStore] Task to input set:",e.value)},getAndClearTaskToInput:()=>{const l=e.value;return e.value="",console.log("[TaskStore] getAndClearTaskToInput returning:",l),l},markTaskAsProcessed:()=>{console.log("[TaskStore] markTaskAsProcessed called, current task:",t.value),t.value?(t.value.processed=!0,console.log("[TaskStore] Task marked as processed:",t.value)):console.log("[TaskStore] No current task to mark as processed")},clearTask:()=>{t.value=null},hasUnprocessedTask:()=>{const l=t.value&&!t.value.processed;return console.log("[TaskStore] hasUnprocessedTask check - currentTask:",t.value,"result:",l),l},markHomeVisited:()=>{o.value=!0,localStorage.setItem("hasVisitedHome","true")},checkHomeVisited:()=>{const l=localStorage.getItem("hasVisitedHome");return o.value=l==="true",o.value},resetHomeVisited:()=>{o.value=!1,localStorage.removeItem("hasVisitedHome")},emitPlanExecutionRequested:l=>{console.log("[TaskStore] emitPlanExecutionRequested called with payload:",l),window.dispatchEvent(new CustomEvent("plan-execution-requested",{detail:l}))},setTaskRunning:l=>{console.log("[TaskStore] setTaskRunning called with planId:",l),t.value?(t.value.planId=l,t.value.isRunning=!0,console.log("[TaskStore] Updated existing task:",t.value)):(t.value={prompt:"",timestamp:Date.now(),processed:!1,planId:l,isRunning:!0},console.log("[TaskStore] Created new task for running state:",t.value))},stopCurrentTask:async()=>{if(console.log("[TaskStore] stopCurrentTask called"),t.value&&t.value.isRunning&&t.value.planId)try{const{DirectApiService:l}=await W(async()=>{const{DirectApiService:C}=await Promise.resolve().then(()=>ee);return{DirectApiService:C}},void 0);return await l.stopTask(t.value.planId),console.log("[TaskStore] Task stopped successfully"),t.value.isRunning=!1,!0}catch(l){return console.error("[TaskStore] Failed to stop task:",l),!1}return!1},hasRunningTask:()=>{const l=t.value&&t.value.isRunning;return console.log("[TaskStore] hasRunningTask check - result:",l),l}}});class X{isCollapsed=!1;currentTab="list";toggleSidebar(){this.isCollapsed=!this.isCollapsed}switchToTab(e){this.currentTab=e}}const ge=M(new X);class A{static async handleResponse(e){if(!e.ok)try{const o=await e.json(),s=o.error||o.message||`API request failed: ${e.status}`,r=new Error(s);throw o.errorCode&&(r.errorCode=o.errorCode),r}catch(o){throw o instanceof Error?o:new Error(`API request failed: ${e.status} ${e.statusText}`)}return e}static async createOrUpdatePlanTemplateWithTool(e){try{const o=await fetch("/api/plan-template/create-or-update-with-tool",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)});return await(await this.handleResponse(o)).json()}catch(o){throw console.error("Failed to create or update plan template with tool:",o),o}}static async getPlanTemplateConfigVO(e){try{const o=await fetch(`/api/plan-template/${e}/config`);return await(await this.handleResponse(o)).json()}catch(o){throw console.error("Failed to get plan template config VO:",o),o}}static async getAllPlanTemplateConfigVOs(){try{const e=await fetch("/api/plan-template/list-config");return await(await this.handleResponse(e)).json()}catch(e){throw console.error("Failed to get all plan template config VOs:",e),e}}static async deletePlanTemplate(e){try{const o=await fetch("/api/plan-template/delete",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({planId:e})});return await(await this.handleResponse(o)).json()}catch(o){throw console.error("Failed to delete plan template:",o),o}}}class Z{isCollapsed=!1;selectMemoryId="";conversationId=null;loadMessages=()=>{};intervalId=void 0;CONVERSATION_ID_KEY="currentConversationId";constructor(){this.loadConversationIdFromStorage()}loadConversationIdFromStorage(){try{const e=localStorage.getItem(this.CONVERSATION_ID_KEY);e&&(this.conversationId=e,console.log("[MemoryStore] Restored conversationId from localStorage:",e))}catch(e){console.warn("[MemoryStore] Failed to load conversationId from localStorage:",e)}}saveConversationIdToStorage(){try{this.conversationId?(localStorage.setItem(this.CONVERSATION_ID_KEY,this.conversationId),console.log("[MemoryStore] Saved conversationId to localStorage:",this.conversationId)):(localStorage.removeItem(this.CONVERSATION_ID_KEY),console.log("[MemoryStore] Removed conversationId from localStorage"))}catch(e){console.warn("[MemoryStore] Failed to save conversationId to localStorage:",e)}}toggleSidebar(){this.isCollapsed=!this.isCollapsed,this.isCollapsed?(this.loadMessages(),this.intervalId=window.setInterval(()=>{this.loadMessages()},3e3)):clearInterval(this.intervalId)}selectMemory(e){this.toggleSidebar(),this.selectMemoryId=e}setMemory(e){this.selectMemoryId=e}defaultMemoryId(){this.selectMemoryId=this.generateRandomId()}clearMemoryId(){this.selectMemoryId=""}setConversationId(e){this.conversationId=e,this.saveConversationIdToStorage()}clearConversationId(){this.conversationId=null,this.saveConversationIdToStorage()}getConversationId(){return this.conversationId}generateRandomId(){return Math.random().toString(36).substring(2,10)}setLoadMessages(e){this.loadMessages=e}}const _=M(new Z);class x{static BASE_URL="/api/executor";static async sendMessage(e){return w.withLlmCheck(async()=>{const o={...e,requestSource:"VUE_DIALOG"},s=await fetch(`${this.BASE_URL}/execute`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(o)});if(!s.ok)throw new Error(`API request failed: ${s.status}`);return await s.json()})}static async sendMessageWithDefaultPlan(e,o="VUE_DIALOG"){const s="default-plan-id-001000222",r={userRequirement:e.input};return this.executeByToolName(s,r,e.uploadedFiles,e.uploadKey,o)}static async executeByToolName(e,o,s,r,u="VUE_DIALOG"){return w.withLlmCheck(async()=>{console.log("[DirectApiService] executeByToolName called with:",{toolName:e,replacementParams:o,uploadedFiles:s,uploadKey:r,requestSource:u});const n={toolName:e,requestSource:u};_.conversationId&&(n.conversationId=_.conversationId,console.log("[DirectApiService] Including conversationId from memoryStore:",_.conversationId)),o&&Object.keys(o).length>0&&(n.replacementParams=o,console.log("[DirectApiService] Including replacement params:",o)),s&&s.length>0&&(n.uploadedFiles=s,console.log("[DirectApiService] Including uploaded files:",s.length)),r&&(n.uploadKey=r,console.log("[DirectApiService] Including uploadKey:",r)),console.log("[DirectApiService] Making request to:",`${this.BASE_URL}/executeByToolNameAsync`),console.log("[DirectApiService] Request body:",n);const c=await fetch(`${this.BASE_URL}/executeByToolNameAsync`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(n)});if(console.log("[DirectApiService] Response status:",c.status,c.ok),!c.ok){const T=await c.text();throw console.error("[DirectApiService] Request failed:",T),new Error(`Failed to execute: ${c.status}`)}const m=await c.json();return console.log("[DirectApiService] executeByToolName response:",m),m})}static async stopTask(e){return w.withLlmCheck(async()=>{console.log("[DirectApiService] Stopping task for planId:",e);const o=await fetch(`${this.BASE_URL}/stopTask/${e}`,{method:"POST",headers:{"Content-Type":"application/json"}});if(!o.ok){const s=await o.json().catch(()=>({}));throw new Error(s.error||`Failed to stop task: ${o.status}`)}return await o.json()})}}const ee=Object.freeze(Object.defineProperty({__proto__:null,DirectApiService:x},Symbol.toStringTag,{value:"Module"}));class te{static PLAN_TEMPLATE_URL="/api/plan-template";static async executePlan(e,o,s,r,u,n="VUE_SIDEBAR"){return w.withLlmCheck(async()=>(console.log("[PlanActApiService] executePlan called with:",{planTemplateId:e,rawParam:o,uploadedFiles:s,replacementParams:r,uploadKey:u,requestSource:n}),o&&(r||(r={}),r.userRequirement=o,console.log("[PlanActApiService] Added rawParam to replacementParams:",o)),await x.executeByToolName(e,r,s,u,n)))}static async getPlanVersions(e){const o=await fetch(`${this.PLAN_TEMPLATE_URL}/versions`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({planId:e})});if(!o.ok)throw new Error(`Failed to get plan versions: ${o.status}`);return await o.json()}static async getAllPlanTemplates(){const e=await fetch(`${this.PLAN_TEMPLATE_URL}/list`);if(!e.ok)throw new Error(`Failed to get plan template list: ${e.status}`);return await e.json()}}function oe(){const t=M({title:"",steps:[],directResponse:!1,planType:"dynamic_agent",planTemplateId:"",readOnly:!1,serviceGroup:""}),e=f(!1),o=f(null),s=f([]),r=f(-1),u=f([]),n=f(null),c=f(null),m=()=>t.title,T=()=>t.planType||"dynamic_agent",v=()=>t.serviceGroup||"",S=a=>{t.title=a},y=a=>{t.steps=a||[]},R=a=>{t.planType=a},E=a=>{t.planTemplateId=a},L=a=>{t.serviceGroup=a},l=a=>{a===void 0?delete t.toolConfig:t.toolConfig=a},C=a=>{t.toolConfig||(t.toolConfig={}),t.toolConfig.toolDescription=a},F=a=>{t.toolConfig||(t.toolConfig={}),t.toolConfig.enableInternalToolcall=a},$=a=>{t.toolConfig||(t.toolConfig={}),t.toolConfig.enableHttpService=a},U=a=>{t.toolConfig||(t.toolConfig={}),t.toolConfig.inputSchema=a||[]},I=()=>({...t}),b=a=>{const i={title:a.title||"",steps:(a.steps||[]).map(g=>({...g,selectedToolKeys:g.selectedToolKeys??[]})),directResponse:a.directResponse||!1,planType:a.planType||"dynamic_agent",planTemplateId:a.planTemplateId||"",readOnly:a.readOnly||!1,serviceGroup:a.serviceGroup||""};a.toolConfig&&(i.toolConfig={...a.toolConfig}),Object.assign(t,i)},z=()=>{Object.assign(t,{title:"",steps:[],directResponse:!1,planType:"dynamic_agent",planTemplateId:"",readOnly:!1,serviceGroup:""}),"toolConfig"in t&&delete t.toolConfig,s.value=[],r.value=-1,o.value=null},H=()=>{const a={title:t.title||"",steps:(t.steps||[]).map(i=>({...i,selectedToolKeys:i.selectedToolKeys??[]})),directResponse:t.directResponse||!1,planType:t.planType||"dynamic_agent",planTemplateId:t.planTemplateId||"",readOnly:t.readOnly||!1,serviceGroup:t.serviceGroup||""};return t.toolConfig&&(a.toolConfig={...t.toolConfig}),JSON.stringify(a,null,2)},D=a=>{try{const i=JSON.parse(a);return b(i),!0}catch(i){return o.value=i instanceof Error?i.message:"Invalid JSON format",!1}},G=k(()=>s.value.length>1&&r.value>0),N=k(()=>s.value.length>1&&r.value<s.value.length-1),J=()=>{if(G.value&&r.value>0){r.value--;const a=s.value[r.value]||"";D(a)}},V=()=>{if(N.value&&r.value<s.value.length-1){r.value++;const a=s.value[r.value]||"";D(a)}},K=a=>{r.value<s.value.length-1&&(s.value=s.value.slice(0,r.value+1)),s.value.push(a),r.value=s.value.length-1},B=async a=>{if(!a)return o.value="Plan template ID is required",!1;try{e.value=!0,o.value=null;const i=await A.getPlanTemplateConfigVO(a);b(i);try{const g=await te.getPlanVersions(a);s.value=g.versions||[],s.value.length>0?r.value=s.value.length-1:r.value=-1}catch(g){console.warn("Failed to load plan versions:",g),s.value=[],r.value=-1}return!0}catch(i){return o.value=i instanceof Error?i.message:"Failed to load plan template config",console.error("Failed to load plan template config:",i),!1}finally{e.value=!1}};return{config:t,isLoading:e,error:o,planVersions:s,currentVersionIndex:r,planTemplateList:u,selectedTemplate:n,currentPlanTemplateId:c,getTitle:m,getPlanType:T,getServiceGroup:v,getConfig:I,setTitle:S,setSteps:y,setPlanType:R,setPlanTemplateId:E,setServiceGroup:L,setToolConfig:l,setToolDescription:C,setEnableInternalToolcall:F,setEnableHttpService:$,setInputSchema:U,setConfig:b,reset:z,load:B,save:async()=>{if(!t.planTemplateId)return o.value="Plan template ID is required",!1;try{e.value=!0,o.value=null;const a=await A.createOrUpdatePlanTemplateWithTool(I());if(a.success){const i=t.planTemplateId;if(i){if(await B(i),n.value?.planTemplateId===i){const h=I();n.value={...n.value,...h}}const g=u.value.findIndex(h=>h.planTemplateId===i);if(g>=0){const h=I();u.value[g]={...u.value[g],...h}}}}return a.success}catch(a){return o.value=a instanceof Error?a.message:"Failed to save plan template config",console.error("Failed to save plan template config:",a),!1}finally{e.value=!1}},validate:()=>{const a=[];return t.planTemplateId?.trim()||a.push("Plan template ID is required"),t.title?.trim()||a.push("Title is required"),(!t.steps||t.steps.length===0)&&a.push("At least one step is required"),{isValid:a.length===0,errors:a}},generateJsonString:H,fromJsonString:D,rollbackVersion:J,restoreVersion:V,updateVersionsAfterSave:K,canRollback:G,canRestore:N,parseDateTime:a=>a?Array.isArray(a)&&a.length>=6?new Date(a[0],a[1]-1,a[2],a[3],a[4],a[5],Math.floor(a[6]/1e6)):typeof a=="string"?new Date(a):new Date:new Date,getAllCoordinatorToolsFromTemplates:()=>{const a=[];for(const i of u.value){if(!i.toolConfig)continue;const g=i.toolConfig;if(!g.enableInternalToolcall)continue;let h="[]";g.inputSchema&&Array.isArray(g.inputSchema)&&(h=JSON.stringify(g.inputSchema));const j={toolName:i.title||"",toolDescription:g.toolDescription||"",planTemplateId:i.planTemplateId||"",inputSchema:h,enableInternalToolcall:g.enableInternalToolcall??!0,enableHttpService:g.enableHttpService??!1,enableMcpService:g.enableMcpService??!1};i.serviceGroup&&(j.serviceGroup=i.serviceGroup),a.push(j)}return a},getCoordinatorToolConfig:()=>u.value.some(a=>a.toolConfig!==void 0)}}let P=null;function q(){return P||(P=oe()),P}class ae{isLoading=!1;errorMessage="";hasTaskRequirementModified=!1;organizationMethod="by_time";templateServiceGroups=new Map;groupCollapseState={};constructor(){const e=localStorage.getItem("sidebarOrganizationMethod");e&&["by_time","by_abc","by_group_time","by_group_abc"].includes(e)&&(this.organizationMethod=e),this.loadGroupCollapseState()}loadGroupCollapseState(){try{const e=localStorage.getItem("sidebarGroupCollapseState");if(e){const o=JSON.parse(e);this.groupCollapseState=o||{}}}catch(e){console.warn("[TemplateStore] Failed to load group collapse state:",e)}}saveGroupCollapseState(){try{localStorage.setItem("sidebarGroupCollapseState",JSON.stringify(this.groupCollapseState))}catch(e){console.warn("[TemplateStore] Failed to save group collapse state:",e)}}toggleGroupCollapse(e){const o=e??"null",s=this.groupCollapseState[o]??!1;this.groupCollapseState[o]=!s,this.saveGroupCollapseState()}isGroupCollapsed(e){const o=e??"null";return this.groupCollapseState[o]??!1}parseDateTime(e){return e?Array.isArray(e)&&e.length>=6?new Date(e[0],e[1]-1,e[2],e[3],e[4],e[5],Math.floor(e[6]/1e6)):typeof e=="string"?new Date(e):new Date:new Date}templateConfig=q();setOrganizationMethod(e){this.organizationMethod=e,localStorage.setItem("sidebarOrganizationMethod",e)}async loadPlanTemplateList(){this.isLoading=!0,this.errorMessage="";try{console.log("[TemplateStore] Starting to load plan template list...");const e=await A.getAllPlanTemplateConfigVOs();this.templateConfig.planTemplateList.value=e,this.templateServiceGroups.clear();for(const o of this.templateConfig.planTemplateList.value){const s=o.planTemplateId;if(s){const r=o.serviceGroup||"";r&&this.templateServiceGroups.set(s,r)}}console.log(`[TemplateStore] Successfully loaded ${this.templateConfig.planTemplateList.value.length} plan templates`)}catch(e){console.error("[TemplateStore] Failed to load plan template list:",e),this.templateConfig.planTemplateList.value=[];const o=e instanceof Error?e.message:"Unknown error";this.errorMessage=`Load failed: ${o}`}finally{this.isLoading=!1}}async selectTemplate(e){this.templateConfig.currentPlanTemplateId.value=e.planTemplateId||null,this.templateConfig.selectedTemplate.value=e,this.hasTaskRequirementModified=!1,console.log(`[TemplateStore] Selected plan template: ${e.planTemplateId}`)}async createNewTemplate(e){const o={planTemplateId:`new-${Date.now()}`,title:Q.global.t("sidebar.newTemplateName"),planType:e,createTime:new Date().toISOString(),updateTime:new Date().toISOString()};this.templateConfig.selectedTemplate.value=o,this.templateConfig.currentPlanTemplateId.value=null,this.hasTaskRequirementModified=!1,console.log("[TemplateStore] Created new empty plan template")}async deleteTemplate(e){const o=e.planTemplateId;if(!o){console.warn("[TemplateStore] deleteTemplate: Invalid template object or ID");return}try{await A.deletePlanTemplate(o),this.templateConfig.currentPlanTemplateId.value===o&&this.clearSelection(),await this.loadPlanTemplateList(),console.log(`[TemplateStore] Plan template ${o} has been deleted`)}catch(s){throw console.error("Failed to delete plan template:",s),await this.loadPlanTemplateList(),s}}clearSelection(){this.templateConfig.currentPlanTemplateId.value=null,this.templateConfig.selectedTemplate.value=null,this.hasTaskRequirementModified=!1}}const d=new ae,se=q(),p=M({isLoading:d.isLoading,errorMessage:d.errorMessage,hasTaskRequirementModified:d.hasTaskRequirementModified,organizationMethod:d.organizationMethod,templateServiceGroups:d.templateServiceGroups,groupCollapseState:d.groupCollapseState,loadGroupCollapseState:()=>d.loadGroupCollapseState(),saveGroupCollapseState:()=>d.saveGroupCollapseState(),toggleGroupCollapse:t=>{d.toggleGroupCollapse(t);const e=t??"null";p.groupCollapseState[e]=d.groupCollapseState[e],p.groupCollapseState={...p.groupCollapseState}},isGroupCollapsed:t=>d.isGroupCollapsed(t),parseDateTime:t=>d.parseDateTime(t),setOrganizationMethod:t=>{d.setOrganizationMethod(t),p.organizationMethod=t},loadPlanTemplateList:async()=>{await d.loadPlanTemplateList(),p.isLoading=d.isLoading,p.errorMessage=d.errorMessage,p.templateServiceGroups=d.templateServiceGroups},selectTemplate:t=>d.selectTemplate(t),createNewTemplate:t=>d.createNewTemplate(t),deleteTemplate:t=>d.deleteTemplate(t),clearSelection:()=>d.clearSelection()}),O=k(()=>{const t=[...se.planTemplateList.value];switch(p.organizationMethod){case"by_time":return t.sort((e,o)=>{const s=p.parseDateTime(e.updateTime??e.createTime);return p.parseDateTime(o.updateTime??o.createTime).getTime()-s.getTime()});case"by_abc":return t.sort((e,o)=>{const s=(e.title??"").toLowerCase(),r=(o.title??"").toLowerCase();return s.localeCompare(r)});case"by_group_time":case"by_group_abc":{const e=new Map,o=[];t.forEach(n=>{const c=n.planTemplateId||"",m=p.templateServiceGroups.get(c)??"";!m||m==="default"||m===""?o.push(n):(e.has(m)||e.set(m,[]),e.get(m).push(n))});const s=new Map;e.forEach((n,c)=>{const m=[...n];p.organizationMethod==="by_group_time"?m.sort((T,v)=>{const S=p.parseDateTime(T.updateTime??T.createTime);return p.parseDateTime(v.updateTime??v.createTime).getTime()-S.getTime()}):m.sort((T,v)=>{const S=(T.title??"").toLowerCase(),y=(v.title??"").toLowerCase();return S.localeCompare(y)}),s.set(c,m)}),p.organizationMethod==="by_group_time"?o.sort((n,c)=>{const m=p.parseDateTime(n.updateTime??n.createTime);return p.parseDateTime(c.updateTime??c.createTime).getTime()-m.getTime()}):o.sort((n,c)=>{const m=(n.title??"").toLowerCase(),T=(c.title??"").toLowerCase();return m.localeCompare(T)});const r=[];return r.push(...o),Array.from(s.keys()).sort().forEach(n=>{r.push(...s.get(n))}),r}default:return t.sort((e,o)=>{const s=p.parseDateTime(e.updateTime||e.createTime||"");return p.parseDateTime(o.updateTime||o.createTime||"").getTime()-s.getTime()})}}),re=k(()=>{if(p.organizationMethod!=="by_group_time"&&p.organizationMethod!=="by_group_abc")return new Map([[null,O.value]]);const t=new Map,e=[];O.value.forEach(u=>{const n=u.planTemplateId||"",c=p.templateServiceGroups.get(n)??"";!c||c==="default"||c===""?e.push(u):(t.has(c)||t.set(c,[]),t.get(c).push(u))});const s=new Map;return e.length>0&&s.set(null,e),Array.from(t.keys()).sort().forEach(u=>{s.set(u,t.get(u))}),s});Object.defineProperty(p,"sortedTemplates",{get:()=>O.value,enumerable:!0,configurable:!0});Object.defineProperty(p,"groupedTemplates",{get:()=>re.value,enumerable:!0,configurable:!0});export{x as D,te as P,q as a,A as b,_ as m,ge as s,p as t,me as u};
//# sourceMappingURL=templateStore-BzNwvZlh.js.map
